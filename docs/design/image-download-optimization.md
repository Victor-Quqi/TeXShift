# 设计：图片重复下载与异步加载策略

## 问题

在单次转换中，如果 Markdown 文档内多次引用同一个图片链接，当前实现会为每一次引用都执行一次下载操作。

## 解决方案与未来规划

### 阶段一：添加下载缓存（短期）

**方案**：在单次转换任务中引入一个字典或哈希集作为缓存，键为图片 URL，值为已下载的图片数据。在下载前检查 URL 是否已在缓存中。

- **优点**：实现简单，能立即解决重复下载的问题。
- **缺点**：转换过程仍然是同步的，遇到大文件或慢速网络时，UI 仍会卡顿。

### 阶段二：实现异步占位符加载（长期）

**方案**：
1.  **首次遍历**：当转换器遇到网络图片链接时，先在 OneNote 页面对应位置插入一个临时的文本占位符（例如 `[图片加载中... URL]`），并立即写入其他非图片内容。
2.  **后台下载**：将图片 URL 添加到并发下载队列中，在后台线程进行下载。
3.  **内容替换**：下载完成后，根据 URL 找到页面上的占位符，并将其替换为实际的图片。

- **优点**：极大提升用户体验。文本内容可以秒出，用户无需等待图片加载完成。

---
**相关文件**：
- `TeXShift.Core/Markdown/ImageElementHelper.cs`
- `TeXShift.Core/Utils/ImageLoader.cs`