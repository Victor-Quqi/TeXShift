## **一、开发环境准备**
1. **安装 Visual Studio 2022**  
   - 勾选 **.NET 桌面开发**工作负载。
   - 确保安装 **.NET Framework 4.8 SDK**（Office COM 插件必须用 .NET Framework，而不是 .NET Core/.NET 8）。

2. **确认 Office 版本**  
   - OneNote 桌面版（Office 365，路径：`C:\Program Files\Microsoft Office\root\Office16\ONENOTE.EXE`）。
   - 必须是 **x64** 版本。

---

## **二、新建项目**
1. **创建类库项目**  
   - 类型：**类库 (.NET Framework)**  
   - 目标框架：**.NET Framework 4.8**  
   - 平台：**x64**（在“配置管理器”中设置）。

2. **项目属性配置**  
   - **应用程序 → 程序集信息**：勾选“使程序集 COM 可见”。  
   - **生成**：勾选“为 COM 互操作注册”。  
   - **签名**：创建并使用强名称密钥文件（.snk）。  
   - **调试**：选择“启动外部程序”，路径指向：  
     ```
     C:\Program Files\Microsoft Office\root\Office16\ONENOTE.EXE
     ```

---

## **三、添加引用**
- **COM 引用**：  
  - `Extensibility`（提供 IDTExtensibility2 接口）。  
  - `Microsoft Office 16.0 Object Library`（Ribbon 支持）。  
  - `Microsoft OneNote 16.0 Type Library`（OneNote API）。  
- **.NET 程序集引用**：  
  - `System.Windows.Forms`（用于弹窗）。  

---

## **四、入口类配置**
1. 新建 `Connect.cs`，实现 `IDTExtensibility2` 和 `IRibbonExtensibility`。
2. 类上添加：  
   - `[ComVisible(true)]`  
   - `[Guid("你的类 GUID")]`（用 VS 工具生成）。  
   - `[ProgId("TeXShift.Connect")]`。

---

## **五、注册 COM 插件**
1. **生成项目**（VS 必须以管理员身份运行，才能注册 COM）。  
2. 如果 VS 注册不稳定，手动注册：  
   ```bat
   "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\RegAsm.exe" "你的DLL路径\TeXShift.dll" /codebase /tlb
   ```
   - `/codebase`：写入 DLL 路径到注册表。  
   - `/tlb`：生成类型库。

3. 检查注册表：  
   - `HKCR\CLSID\{你的类 GUID}\InprocServer32` 默认值应为 `mscoree.dll`，并有 `CodeBase` 指向 DLL。  
   - `HKCU\Software\Microsoft\Office\OneNote\Addins\TeXShift.Connect`：  
     ```
     LoadBehavior = 3
     FriendlyName = TeXShift
     Description = TeXShift Dev Add-in
     CommandLineSafe = 1
     ```

---

## **六、强制使用 dllhost.exe（解决加载失败）**
1. 新建 `.reg` 文件并导入：
   ```reg
   Windows Registry Editor Version 5.00

   [HKEY_CLASSES_ROOT\CLSID\{你的类 GUID}]
   "AppID"="{你的类 GUID}"

   [HKEY_CLASSES_ROOT\AppID\{你的类 GUID}]
   "DllSurrogate"=""
   ```
2. 重启 OneNote → 插件会在 **dllhost.exe** 中运行（任务管理器命令行列可见 `/Processid:{GUID}`）。

---

## **七、调试与验证**
- **调试方式**：  
  - F5 启动 OneNote（如果 VS 以管理员运行，OneNote也会是管理员，可能导致插件加载失败 → 推荐放弃 F5，改用手动启动）。  
  - 或推荐手动启动 OneNote → VS 附加到 `dllhost.exe /Processid:{GUID}`（代码类型：托管 .NET Framework 4.x）。  
- **验证加载**：  
  - 可在构造函数或静态构造里写日志到本地。  
  - Ribbon 出现并按钮能响应，说明加载成功。

---

## **八、测试循环**
1. 关闭 OneNote（确保 `ONENOTE.EXE` 和 dllhost 都退出）。  
2. 修改代码 → **重新生成**（不改 GUID/路径就不必重复注册）。  
3. 启动 OneNote测试功能。

---

## **九、关键注意事项**
- **必须用 .NET Framework 4.8**，Office COM 插件不支持 .NET Core/.NET 8。  
- 平台必须 **x64**，与 OneNote 匹配。  
- 如果加载失败，`LoadBehavior` 可能会从 3 变 2 → 检查注册表、路径、权限。  
- 禁用其他插件避免反调试干扰。  
- 不要以管理员身份运行 OneNote（会导致加载项策略变化）。  
- 保留 `DllSurrogate` 配置，确保 dllhost 模式稳定