### **第一优先级：核心框架与最小可行产品 (MVP)**

这个阶段的目标是搭建项目的骨架，并实现一个最基础、但端到端完整的功能循环。这是后续一切功能的基础，也是确保项目不至于“开天窗”的底线。

1.  **项目与环境搭建**
    *   **任务**：在 Visual Studio 2022 中创建 OneNote COM Add-in 项目。
    *   **目标**：成功在 OneNote 中加载插件，并显示一个自定义的 Ribbon 区域和一个可点击的按钮。这是与 OneNote API 交互的第一步。

2.  **实现核心读取逻辑**
    *   **任务**：实现 `GetPageContent` 的调用，并解析返回的 XML。
    *   **目标**：能够准确区分**光标模式**和**选区模式**。这是您在项目概述中提到的“最关键的发现”，务必最先攻克。可以先通过打印或调试窗口输出当前模式和选中的内容来验证其正确性。

3.  **实现最基础的单向转换（Markdown -> 富文本）**
    *   **任务**：选择一个最简单也最常见的 Markdown 元素，例如**二级标题 (`## Text`)** 或**加粗 (`**Text**`)**。
    *   **目标**：在用户选中包含这类 Markdown 语法的文本后，点击按钮，能够将其转换为 OneNote 中对应的富文本格式（例如，将字体设置为某个字号或加粗）。这需要研究如何构造用于 `UpdatePageContent` 的 XML 字符串。

4.  **实现基础的回写逻辑**
    *   **任务**：调用 `UpdatePageContent` 将上一步转换后的内容写回 OneNote 页面。
    *   **目标**：完成“读取 -> 解析 -> 转换 -> 回写”的完整闭环。至此，MVP 完成。

**此阶段完成后，您将拥有一个可以演示的核心功能，证明了项目技术路线的可行性。**

---

### **第二优先级：核心功能与视觉效果增强**

这个阶段的目标是实现那些在演示中最能吸引眼球、最具价值的功能。这些功能直接体现了插件的先进性和实用性。

1.  **预览窗格 (Preview Pane)**
    *   **任务**：创建一个停靠任务窗格 (Task Pane) 作为预览窗口。
    *   **目标**：当用户在 OneNote 中选择内容时，预览窗格能根据第一阶段的逻辑，实时（或通过刷新按钮）渲染出转换后的效果。例如，在 OneNote 编辑器里是 `## Title`，预览窗格里就显示为一个大号字体的 "Title"。**这是视觉冲击力最强的部分**。

2.  **代码块高亮转换 (Markdown -> 富文本)**
    *   **任务**：集成一个轻量级的 .NET 语法高亮库（如 ColorCode-Portable 或其他）。
    *   **目标**：实现将 Markdown 的代码块（例如 ` ```csharp ... ``` `）转换为带有背景色和语法高亮的 OneNote 富文本。这个“before/after”对比效果非常直观，能极大提升演示效果。

3.  **Mermaid 图表生成 (Mermaid -> PNG)**
    *   **任务**：研究将 Mermaid 文本转换为 PNG 图片的方案。这可能需要调用外部的 JavaScript 引擎或一个简单的 Web 服务。
    *   **目标**：实现将 `mermaid ...` 代码块一键转换为 PNG 图片并插入到 OneNote 中。将文本直接变成图表，是另一个极具说服力的功能点。

4.  **完善双向转换逻辑**
    *   **任务**：基于已实现的 Markdown 元素（标题、代码块），实现从富文本到 Markdown 的反向转换。
    *   **目标**：让“一键转换”按钮能够智能判断当前选区内容，并执行正确的转换方向。

**此阶段完成后，项目的主要亮点功能基本成型，足以进行一次非常成功的课程项目演示。**

---

### **第三优先级：功能完善与体验提升**

如果第二阶段进展顺利，时间充裕，可以着手实现这些功能，它们会让插件更完整、更实用。

1.  **设置界面与样式映射**
    *   **任务**：创建一个设置窗口。
    *   **目标**：允许用户自定义最基本的样式映射规则，例如各级 Markdown 标题对应的 OneNote 字体大小和颜色，或者代码块的背景色。这展示了项目的可扩展性和用户友好性。

2.  **快捷键绑定**
    *   **任务**：为最高频的操作（如“一键转换”、“打开/关闭预览窗格”）添加可配置的快捷键。
    *   **目标**：提升操作效率，是插件从“玩具”到“工具”的重要一步。

3.  **支持 LaTeX 公式转换**
    *   **任务**：研究 OneNote 的 OMML (Office Math Markup Language) 与 LaTeX 之间的转换。
    *   **目标**：至少实现从 OneNote 原生公式到 LaTeX 文本的单向转换。如果能实现反向转换，将是项目的一大技术亮点，但其复杂性也较高，需要谨慎评估投入产出比。

---

### **第四优先级：锦上添花（可选）**

这些是收尾工作，可以在所有核心功能都稳定后再考虑。

1.  **批量处理功能**
    *   **任务**：实现对当前页面所有符合规则的内容进行批量转换。
    *   **目标**：提供转换报告（成功数、失败数）。这个功能很实用，但在演示中不如实时预览那样直观。

2.  **缓存机制**
    *   **任务**：实现概述中提到的缓存开关和清理功能。
    *   **目标**：为反向转换提供数据支持，并提升性能。

3.  **全面的错误处理与提示**
    *   **任务**：对可能发生的 API 调用失败、格式解析错误等情况进行捕获和友好提示。
    *   **目标**：提升插件的健壮性。